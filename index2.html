 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>PARKBNB — Parking Finder & Booking (BW Prototype)</title>
<style>
/* ===================== MONOCHROME THEME ===================== */
:root{
  --bg:#000;              /* page */
  --surface:#0a0a0a;      /* panels */
  --elev:#111;            /* cards */
  --text:#fff;            /* main text */
  --muted:#b8b8b8;        /* secondary */
  --line:#1f1f1f;         /* hairline borders */
  --chip:#0f0f0f;         /* chips / inputs */
  --brand:#fff;           /* action */
  --accent:#e6e6e6;       /* alt action */
  --danger:#ff3b30;
  --warn:#ffd60a;
  --r:14px;
  --topbar-h:60px;
  --tabbar-h:66px;
  --shadow:0 10px 40px rgba(0,0,0,.55);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:
    radial-gradient(1200px 600px at 100% -20%, rgba(255,255,255,.06), transparent),
    var(--bg);
  color:var(--text);
  font:16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  letter-spacing:.2px;
}

/* Typography — bold, high-contrast */
h1,h2,h3,b,strong{font-weight:800; letter-spacing:.3px}
small,.small{font-size:12.5px; color:var(--muted)}
.kbd{border:1px solid var(--line); background:#0b0b0b; padding:2px 6px; border-radius:6px; font-size:12px; color:var(--muted)}

/* Focus ring for accessibility */
:focus-visible{outline:2px solid #fff; outline-offset:2px; border-radius:8px}

/* ====================== LAYOUT ====================== */
.app{
  min-height:100svh;
  padding-top:calc(var(--topbar-h) + env(safe-area-inset-top,0px));
  padding-bottom:calc(var(--tabbar-h) + env(safe-area-inset-bottom,0px));
  display:grid; grid-template-rows:auto 1fr;
}

.topbar{
  position:fixed; inset:0 0 auto 0; height:var(--topbar-h);
  border-bottom:1px solid var(--line);
  background:color-mix(in srgb, #000 78%, transparent);
  backdrop-filter:blur(12px);
  z-index:30;
}
.topbar .inner{
  height:100%; display:flex; align-items:center; gap:14px;
  padding:0 clamp(12px,4vw,24px);
}
.logo{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.4px; cursor:pointer}
.logo .dot{width:14px; height:14px; border-radius:50%; background:#fff}

.searchbar{
  flex:1; display:flex; align-items:center; gap:10px;
  background:var(--chip); border:1px solid var(--line); border-radius:999px; padding:10px 12px;
}
.searchbar input{flex:1; min-width:0; background:transparent; border:0; color:#fff; outline:0; font-weight:700}
.searchbar .btn{white-space:nowrap}

/* Desktop nav (hidden on mobile) */
.nav{display:none; gap:6px; margin-left:auto}
.nav button{
  background:transparent; border:1px solid var(--line); color:#fff;
  padding:10px 12px; border-radius:10px; font-weight:700; letter-spacing:.2px; cursor:pointer
}
.nav button.active,.nav button:hover{background:#0e0e0e}

/* Main area */
.main{padding:14px clamp(12px,4vw,28px); display:grid; gap:14px}

/* Results grid */
.results{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
@media (min-width:760px){ .results{grid-template-columns:repeat(3,1fr)} }
@media (min-width:980px){
  .app{padding-bottom:0}
  .main{grid-template-columns:320px 1fr; align-items:start}
  .results{grid-template-columns:repeat(3, minmax(220px,1fr))}
  .nav{display:flex}
}

/* Cards */
.card{
  background:var(--elev); border:1px solid var(--line); border-radius:var(--r);
  overflow:hidden; box-shadow:var(--shadow); transform:translateZ(0)
}
.card .img{
  aspect-ratio:16/10;
  background:
    linear-gradient(135deg, #fff0 0%, #fff1 100%),
    repeating-linear-gradient( 45deg, #1a1a1a 0 8px, #0f0f0f 8px 16px);
  position:relative
}
.card .price{position:absolute; bottom:8px; left:8px; background:#000; padding:6px 8px; border-radius:8px; font-weight:900; border:1px solid #1e1e1e}
.card .content{padding:12px; display:grid; gap:10px}
.meta{color:var(--muted); font-weight:600; font-size:13px}
.row{display:flex; align-items:center; justify-content:space-between; gap:10px; min-width:0}
.fav{border:0; background:transparent; color:#fff; cursor:pointer; font-size:18px; opacity:.85; transition:transform .12s}
.fav:active{transform:scale(.9)} .fav.active{opacity:1}

/* Panels / sections */
.panel{background:var(--surface); border:1px solid var(--line); border-radius:var(--r); overflow:hidden; box-shadow:var(--shadow)}
.section-title{padding:12px 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between}
.section-title h3{margin:0; font-size:15px; font-weight:900}
.section-body{padding:12px; display:grid; gap:12px}

/* Inputs */
.input,.select{display:flex; align-items:center; gap:10px; background:#0c0c0c; border:1px solid var(--line); border-radius:12px; padding:10px 12px}
.input input,.select select{flex:1; background:transparent; border:0; color:#fff; outline:0; font-weight:700}
.filter-row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
@media (max-width:420px){ .filter-row{grid-template-columns:1fr} }
.badges{display:flex; flex-wrap:wrap; gap:8px}
.badge{background:#0c0c0c; border:1px solid var(--line); color:#eaeaea; padding:6px 10px; border-radius:999px; font-weight:700}

/* Buttons — bold, white on black */
.btn{
  --bg:transparent; --fg:#fff; --bd:var(--line);
  background:var(--bg); color:var(--fg); border:2px solid var(--bd);
  padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:900; letter-spacing:.2px
}
.btn.primary{ --bg:#fff; --fg:#000; --bd:#fff }
.btn.ghost{ --bg:transparent; --fg:#fff; --bd:var(--line) }
.btn.warn{ --bg:var(--warn); --fg:#000; --bd:var(--warn) }
.btn.danger{ --bg:var(--danger); --fg:#fff; --bd:var(--danger) }
.btn:active{transform:translateY(1px)}

/* Desktop filters panel (hidden on mobile) */
.filters-desktop{display:none}
@media (min-width:980px){ .filters-desktop{display:block} }

/* CTA row */
.panel .cta{display:flex; align-items:center; justify-content:space-between; padding:10px; border-top:1px solid var(--line)}

/* Map — monochrome */
.map{
  background:linear-gradient(180deg, #0b0b0b, #0e0e0e); border:1px solid var(--line);
  border-radius:var(--r); overflow:hidden; min-height:280px; position:relative
}
.map svg path, .map svg rect, .map svg g { color:#fff }
.pin{
  position:absolute; width:18px; height:18px; border-radius:50%;
  background:#fff; box-shadow:0 10px 20px rgba(0,0,0,.6); transform:translate(-50%,-50%);
  cursor:pointer; transition:transform .18s
}
.pin:active{transform:translate(-50%,-50%) scale(.9)}
.gate{position:absolute; left:12px; bottom:12px; background:#0b0b0b; border:1px solid var(--line); padding:12px; border-radius:12px; max-width:90%}
.arm{width:120px; height:6px; background:linear-gradient(90deg, #fff, #bbb 60%, #fff); border-radius:3px; transform-origin:10px 3px; transition:transform .7s cubic-bezier(.2,.7,.1,1)}
.gate.open .arm{transform:rotate(-70deg)}
.pole{width:12px; height:40px; background:#151515; border:1px solid var(--line); margin-top:6px; border-radius:6px}

/* Bottom tab bar */
.tabbar{
  position:fixed; inset:auto 0 0 0; height:var(--tabbar-h);
  background:color-mix(in srgb, #000 78%, transparent);
  border-top:1px solid var(--line);
  display:grid; grid-template-columns:repeat(5,1fr); z-index:25;
  padding-bottom:env(safe-area-inset-bottom,0px); backdrop-filter:blur(10px)
}
.tabbar button{
  background:transparent; border:0; display:grid; place-items:center; gap:4px; color:#dcdcdc; font-weight:800; font-size:12px
}
.tabbar button.active{color:#fff}

/* Filters sheet (mobile) */
.sheet{
  position:fixed; inset:auto 0 0 0; transform:translateY(110%);
  background:#0a0a0a; border-top:1px solid var(--line);
  border-radius:18px 18px 0 0; box-shadow:var(--shadow);
  display:grid; grid-template-rows:auto 1fr auto; max-height:86svh; z-index:40;
  transition:transform .35s cubic-bezier(.2,.8,.2,1);
}
.sheet.open{ transform:translateY(0) }
.sheet header,.sheet footer{padding:12px 14px; border-bottom:1px solid var(--line)}
.sheet footer{border-bottom:0; border-top:1px solid var(--line); display:flex; gap:10px; justify-content:space-between; align-items:center}
.sheet .body{padding:12px; overflow:auto; display:grid; gap:12px}

/* FAB */
.fab{
  position:fixed; right:16px; bottom:calc(var(--tabbar-h) + 16px + env(safe-area-inset-bottom,0px));
  width:58px; height:58px; border-radius:50%; display:grid; place-items:center;
  background:#fff; color:#000; border:0; box-shadow:var(--shadow); cursor:pointer; font-weight:900
}

/* Pages */
.page{display:none} .page.active{display:block}

/* Tables */
.table{width:100%; border-collapse:collapse}
.table th,.table td{border-bottom:1px dashed var(--line); padding:10px; text-align:left; font-size:14px}
.table th{color:#eaeaea; font-weight:900}

/* Modals */
.modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50}
.modal{width:min(720px,94vw); background:#0a0a0a; border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow:var(--shadow)}
.modal header{padding:12px 14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center}
.modal .body{padding:14px; display:grid; gap:12px}
.modal footer{padding:12px; border-top:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:10px}
.close{background:transparent; border:0; color:#fff; font-size:22px; cursor:pointer}

/* Toast */
.toast{position:fixed; right:12px; bottom:calc(var(--tabbar-h) + 12px + env(safe-area-inset-bottom,0px)); background:#0b0b0b; border:1px solid var(--line); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); display:none; font-weight:800}
</style>
</head>
<body>
<!-- ===== Topbar ===== -->
<div class="topbar">
  <div class="inner">
    <div class="logo" onclick="Router.go('find')" title="PARKBNB"><div class="dot"></div><span>PARKBNB</span></div>
    <div class="searchbar" role="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.4"/></svg>
      <input id="q" placeholder="Search city, landmark…" onkeydown="if(event.key==='Enter')App.search()">
      <button class="btn" onclick="App.search()">SEARCH</button>
    </div>
    <nav class="nav" aria-label="Primary">
      <button class="active" data-tab="find" onclick="Router.go('find')">FIND</button>
      <button data-tab="trips" onclick="Router.go('trips')">BOOKINGS</button>
      <button data-tab="host" onclick="Router.go('host')">HOST</button>
      <button data-tab="inbox" onclick="Router.go('inbox')">INBOX</button>
      <button data-tab="profile" onclick="Router.go('profile')">PROFILE</button>
    </nav>
  </div>
</div>

<div class="app" id="app">
  <main class="main">
    <!-- ===== Desktop Filters ===== -->
    <aside class="filters-desktop panel">
      <div class="section-title">
        <h3>FILTERS</h3><button class="btn ghost" onclick="App.resetFilters()">RESET</button>
      </div>
      <div class="section-body">
        <div class="filter-row">
          <label class="input"><span class="small">Vehicle</span>
            <select id="vehicle"><option>Car</option><option>Bike</option><option>EV</option><option>Van</option></select>
          </label>
          <label class="input"><span class="small">Max price (AED/hr)</span>
            <input id="price" type="range" min="5" max="60" step="1" value="40" oninput="priceOut.textContent=this.value">
          </label>
        </div>
        <div class="row small"><span></span><span><b id="priceOut">40</b> AED/hr</span></div>
        <div class="filter-row">
          <label class="select"><span class="small">Amenities</span>
            <select id="amenity" multiple size="3" aria-label="Amenities">
              <option>Covered</option><option>Guarded</option><option>EV charger</option><option>24/7</option><option>Wide bay</option>
            </select>
          </label>
          <label class="select"><span class="small">Access</span>
            <select id="access"><option>QR gate</option><option>Keypad</option><option>Attendant</option></select>
          </label>
        </div>
        <div class="badges" id="activeFilters"></div>
      </div>
      <div class="cta">
        <div class="small">Showing <b id="count">0</b> results</div>
        <div class="row" style="gap:8px">
          <button class="btn" onclick="App.saveSearch()">SAVE</button>
          <button class="btn primary" onclick="App.search()">APPLY</button>
        </div>
      </div>
    </aside>

    <!-- ===== Pages ===== -->
    <section style="display:grid; gap:14px">
      <!-- FIND -->
      <div id="page-find" class="page panel active">
        <div class="section-title">
          <h3>NEARBY SPOTS</h3>
          <div class="small">Gate: <span class="kbd">G</span></div>
        </div>
        <div class="section-body">
          <div class="results" id="results"></div>
          <div class="map" id="map">
            <svg viewBox="0 0 800 300" width="100%" height="230" role="img" aria-label="Map">
              <rect x="0" y="0" width="800" height="300" fill="#0d0d0d"/>
              <g stroke="#2a2a2a" stroke-width="1">
                <path d="M60,0 L60,340 M160,0 L160,340 M260,0 L260,340 M360,0 L360,340 M460,0 L460,340 M560,0 L560,340 M660,0 L660,340 M760,0 L760,340"/>
                <path d="M0,40 L800,40 M0,120 L800,120 M0,200 L800,200 M0,280 L800,280"/>
              </g>
            </svg>
            <div class="gate" id="gate">
              <div class="arm"></div><div class="pole"></div>
              <div class="row" style="margin-top:8px">
                <button class="btn primary" onclick="App.toggleGate()">LIFT BARRIER</button>
                <button class="btn ghost" onclick="App.shareAccess()">SHARE QR</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TRIPS -->
      <div id="page-trips" class="page panel">
        <div class="section-title"><h3>BOOKINGS</h3><button class="btn ghost" onclick="App.clearTrips()">CLEAR</button></div>
        <div class="section-body" id="tripsList"></div>
      </div>

      <!-- HOST -->
      <div id="page-host" class="page panel">
        <div class="section-title"><h3>YOUR LISTINGS</h3><button class="btn primary" onclick="App.show('newListingModal')">+ NEW</button></div>
        <div class="section-body" id="hostList"></div>
      </div>

      <!-- INBOX -->
      <div id="page-inbox" class="page panel">
        <div class="section-title"><h3>INBOX</h3></div>
        <div class="section-body" id="inbox">
          <div class="input">
            <input id="msgTo" placeholder="Send message to host / guest (email)">
            <button class="btn" onclick="App.sendMessage()">SEND</button>
          </div>
          <table class="table" id="msgTable">
            <thead><tr><th>When</th><th>To</th><th>Message</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- PROFILE -->
      <div id="page-profile" class="page panel">
        <div class="section-title"><h3>PROFILE</h3></div>
        <div class="section-body">
          <div class="filter-row">
            <label class="input"><span class="small">Name</span><input id="pName" placeholder="Your name"></label>
            <label class="input"><span class="small">Phone</span><input id="pPhone" placeholder="+971…"></label>
          </div>
          <div class="filter-row">
            <label class="input"><span class="small">Car plate</span><input id="pPlate" placeholder="D 12345"></label>
            <label class="input"><span class="small">EV?</span>
              <select id="pEV"><option>No</option><option>Yes</option></select>
            </label>
          </div>
          <div class="row" style="justify-content:end"><button class="btn primary" onclick="App.saveProfile()">SAVE</button></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- FAB (mobile filters) -->
<button class="fab" aria-label="Filters" onclick="App.openSheet()">≡</button>

<!-- Bottom Tabbar -->
<div class="tabbar" role="tablist">
  <button data-tab="find" class="active" onclick="Router.go('find')"><span>FIND</span></button>
  <button data-tab="trips" onclick="Router.go('trips')"><span>BOOK</span></button>
  <button data-tab="host" onclick="Router.go('host')"><span>HOST</span></button>
  <button data-tab="inbox" onclick="Router.go('inbox')"><span>INBOX</span></button>
  <button data-tab="profile" onclick="Router.go('profile')"><span>ME</span></button>
</div>

<!-- FILTER SHEET (mobile) -->
<div id="filterSheet" class="sheet" aria-hidden="true">
  <header class="row"><b>FILTERS</b><button class="btn ghost" onclick="App.closeSheet()">CLOSE</button></header>
  <div class="body">
    <div class="filter-row">
      <label class="input"><span class="small">Vehicle</span>
        <select id="m_vehicle"><option>Car</option><option>Bike</option><option>EV</option><option>Van</option></select>
      </label>
      <label class="input"><span class="small">Max price (AED/hr)</span>
        <input id="m_price" type="range" min="5" max="60" step="1" value="40" oninput="mPriceOut.textContent=this.value">
      </label>
    </div>
    <div class="row small"><span></span><span><b id="mPriceOut">40</b> AED/hr</span></div>
    <div class="filter-row">
      <label class="select"><span class="small">Amenities</span>
        <select id="m_amenity" multiple size="3" aria-label="Amenities">
          <option>Covered</option><option>Guarded</option><option>EV charger</option><option>24/7</option><option>Wide bay</option>
        </select>
      </label>
      <label class="select"><span class="small">Access</span>
        <select id="m_access"><option>QR gate</option><option>Keypad</option><option>Attendant</option></select>
      </label>
    </div>
    <div class="badges" id="m_activeFilters"></div>
  </div>
  <footer>
    <div class="small">Showing <b id="m_count">0</b> results</div>
    <div class="row" style="gap:8px">
      <button class="btn" onclick="App.resetFilters(true)">RESET</button>
      <button class="btn primary" onclick="App.applyMobileFilters()">APPLY</button>
    </div>
  </footer>
</div>

<!-- BOOKING MODAL -->
<div class="modal-backdrop" id="bookingModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="bookTitle">
    <header><h3 id="bookTitle">RESERVE SPOT</h3><button class="close" onclick="App.hide('bookingModal')">×</button></header>
    <div class="body">
      <div class="filter-row">
        <label class="input"><span class="small">From</span><input id="bkFrom" type="datetime-local"></label>
        <label class="input"><span class="small">To</span><input id="bkTo" type="datetime-local"></label>
      </div>
      <div class="filter-row">
        <label class="input"><span class="small">Vehicle</span><input id="bkVehicle" placeholder="e.g., BMW X2"></label>
        <label class="input"><span class="small">Plate</span><input id="bkPlate" placeholder="D 12345"></label>
      </div>
      <div class="row"><div class="small">Rate: <b id="bkRate">AED 12/hr</b></div><div class="small">Est. total: <b id="bkTotal">AED 0</b></div></div>
    </div>
    <footer>
      <div class="small">Payment mocked · QR access on confirm</div>
      <div class="row">
        <button class="btn ghost" onclick="App.hide('bookingModal')">CANCEL</button>
        <button class="btn primary" onclick="App.confirmBooking()">CONFIRM</button>
      </div>
    </footer>
  </div>
</div>

<!-- NEW LISTING MODAL -->
<div class="modal-backdrop" id="newListingModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lstTitle">
    <header><h3 id="lstTitle">CREATE LISTING</h3><button class="close" onclick="App.hide('newListingModal')">×</button></header>
    <div class="body">
      <div class="filter-row">
        <label class="input"><span class="small">Title</span><input id="lstTitleInput" placeholder="Covered bay near City Walk"></label>
        <label class="input"><span class="small">Rate (AED/hr)</span><input id="lstRateInput" type="number" min="5" value="10"></label>
      </div>
      <div class="filter-row">
        <label class="input"><span class="small">Access</span><input id="lstAccessInput" placeholder="QR gate / keypad / attendant"></label>
        <label class="input"><span class="small">Tags</span><input id="lstTagsInput" placeholder="Covered, EV charger"></label>
      </div>
      <label class="input"><span class="small">Address</span><input id="lstAddrInput" placeholder="Street, Area, City"></label>
    </div>
    <footer>
      <span class="small">You can edit/delete later</span>
      <div class="row">
        <button class="btn ghost" onclick="App.hide('newListingModal')">CLOSE</button>
        <button class="btn primary" onclick="App.addListing()">ADD</button>
      </div>
    </footer>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ================== MOCK DATA ================== */
const mockSpots = [
  {id:'p1', title:'Shaded bay · Downtown', rate:12, access:'QR gate', tags:['Covered','24/7'], coords:[220,110]},
  {id:'p2', title:'EV charger · Marina', rate:18, access:'Keypad', tags:['EV charger','Guarded'], coords:[520,200]},
  {id:'p3', title:'Villa driveway · Jumeirah', rate:10, access:'Attendant', tags:['Wide bay'], coords:[160,80]},
  {id:'p4', title:'Mall deck · Mirdif', rate:15, access:'QR gate', tags:['Covered','Guarded'], coords:[720,140]},
  {id:'p5', title:'Open lot · Al Quoz', rate:6, access:'Keypad', tags:['24/7'], coords:[320,240]},
];

/* ================== STORAGE ================== */
const Store = {
  key:k=>`parkbnb_${k}`,
  get(k,def){ try{const v=localStorage.getItem(this.key(k)); return v?JSON.parse(v):def }catch(e){ return def } },
  set(k,v){ localStorage.setItem(this.key(k), JSON.stringify(v)) }
};

/* ================== ROUTER ================== */
const Router = {
  go(tab){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('[data-tab]').forEach(b=>b.classList.remove('active'));
    document.getElementById(`page-${tab}`).classList.add('active');
    document.querySelectorAll(`[data-tab="${tab}"]`).forEach(b=>b.classList.add('active'));
    if(tab==='trips') App.renderTrips();
    if(tab==='host') App.renderHost();
    if(tab==='find') App.renderPins();
    window.scrollTo({top:0, behavior:'smooth'});
  }
};

/* ================== APP ================== */
const App={
  currentSpot:null, blockedSpots:new Set(),

  init(){
    const p=Store.get('profile',{name:'',phone:'',plate:'',ev:'No'});
    pName.value=p.name||''; pPhone.value=p.phone||''; pPlate.value=p.plate||''; pEV.value=p.ev||'No';

    this.renderResults(mockSpots); this.renderPins(); this.updateDesktopBadges(); this.renderTrips(); this.renderHost();

    window.addEventListener('keydown',(e)=>{ if(e.key==='/'){e.preventDefault(); q.focus()} if(e.key.toLowerCase()==='g'){ this.toggleGate() } });

    bkFrom.addEventListener('change',()=>this.updateEstimate()); bkTo.addEventListener('change',()=>this.updateEstimate());
  },

  /* Filters */
  _read(isMobile=false){
    const get=id=>document.getElementById((isMobile?'m_':'')+id);
    return { vehicle:get('vehicle')?.value||'Car',
             price:+(get('price')?.value??40),
             amenity:[...(get('amenity')?.selectedOptions??[])].map(o=>o.value),
             access:get('access')?.value||'QR gate' }
  },

  search(){
    const qv=q.value.toLowerCase(), f=this._read(false);
    const results = mockSpots.filter(s=>{
      const okQ=!qv||s.title.toLowerCase().includes(qv);
      const okP=s.rate<=f.price;
      const okA=!f.access||s.access===f.access;
      const okM=f.amenity.length===0||f.amenity.every(a=>s.tags.includes(a));
      return okQ&&okP&&okA&&okM;
    });
    this.renderResults(results); this.updateDesktopBadges(); this.toast(`${results.length} result${results.length!==1?'s':''}`);
  },

  applyMobileFilters(){
    vehicle.value=m_vehicle.value; price.value=m_price.value; priceOut.textContent=m_price.value; access.value=m_access.value;
    [...amenity.options].forEach(o=>o.selected=false);
    [...m_amenity.selectedOptions].forEach(s=>{ const m=[...amenity.options].find(o=>o.value===s.value); if(m) m.selected=true; });
    this.search(); this.closeSheet();
  },

  resetFilters(isMobile=false){
    if(isMobile){ m_vehicle.value='Car'; m_price.value=40; mPriceOut.textContent=40; m_amenity.selectedIndex=-1; m_access.value='QR gate'; this.updateMobileBadges(); }
    else{ vehicle.value='Car'; price.value=40; priceOut.textContent=40; amenity.selectedIndex=-1; access.value='QR gate'; this.updateDesktopBadges(); this.search(); }
  },

  updateDesktopBadges(){
    const f=this._read(false), box=activeFilters; box.innerHTML='';
    const add=t=>{const b=document.createElement('span'); b.className='badge'; b.textContent=t; box.appendChild(b)};
    add(`≤ AED ${f.price}/hr`); add(f.access); f.amenity.forEach(add);
    count.textContent=document.querySelectorAll('#results .card').length;
  },
  updateMobileBadges(){
    const f=this._read(true), box=m_activeFilters; box.innerHTML='';
    const add=t=>{const b=document.createElement('span'); b.className='badge'; b.textContent=t; box.appendChild(b)};
    add(`≤ AED ${f.price}/hr`); add(f.access); f.amenity.forEach(add);
    m_count.textContent=document.querySelectorAll('#results .card').length;
  },

  /* Renderers */
  renderResults(list){
    results.innerHTML='';
    list.forEach(s=>{
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <div class="img"><div class="price">AED ${s.rate}/hr</div></div>
        <div class="content">
          <div class="row">
            <b style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.title}</b>
            <button class="fav" aria-label="Save" onclick="this.classList.toggle('active');this.textContent=this.classList.contains('active')?'★':'☆'">☆</button>
          </div>
          <div class="meta">${s.access} · ${s.tags.join(' · ')}</div>
          <div class="row">
            <button class="btn" onclick="App.block('${s.id}')">BLOCK 10M</button>
            <button class="btn primary" onclick="App.openBooking('${s.id}')">BOOK</button>
          </div>
        </div>`;
      results.appendChild(card);
    });
  },

  renderPins(){
    [...map.querySelectorAll('.pin')].forEach(p=>p.remove());
    mockSpots.forEach(s=>{
      const pin=document.createElement('div'); pin.className='pin';
      pin.style.left=s.coords[0]+'px'; pin.style.top=s.coords[1]+'px';
      pin.title=`${s.title} — AED ${s.rate}/hr`; pin.onclick=()=>this.openBooking(s.id);
      map.appendChild(pin);
    });
  },

  /* Booking */
  openBooking(id){
    const s=mockSpots.find(x=>x.id===id); this.currentSpot=s;
    bkRate.textContent=`AED ${s.rate}/hr`;
    const now=new Date(), to=new Date(now.getTime()+2*3600e3);
    const pad=n=>String(n).padStart(2,'0'), fmt=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    bkFrom.value=fmt(now); bkTo.value=fmt(to);
    bkVehicle.value=Store.get('profile',{}).name?`${Store.get('profile',{}).name}'s vehicle`:''; bkPlate.value=Store.get('profile',{}).plate||'';
    this.updateEstimate(); this.show('bookingModal');
  },
  updateEstimate(){
    const from=new Date(bkFrom.value), to=new Date(bkTo.value);
    const hrs=Math.max(0,(to-from)/3600e3); const total=(hrs*(this.currentSpot?.rate||0))||0;
    bkTotal.textContent=`AED ${total.toFixed(2)}`;
  },
  confirmBooking(){
    const trips=Store.get('trips',[]), id='t'+Math.random().toString(36).slice(2,8);
    trips.push({id, spot:this.currentSpot, from:bkFrom.value, to:bkTo.value, plate:bkPlate.value||'—', status:'upcoming', qr:this.genQR()});
    Store.set('trips',trips); this.hide('bookingModal'); this.toast('Booking confirmed · QR ready'); Router.go('trips');
  },

  /* Trips */
  genQR(){ return 'QR-' + Math.random().toString(36).slice(2,10).toUpperCase(); },
  renderTrips(){
    const list=Store.get('trips',[]);
    tripsList.innerHTML = list.length? '' : '<div class="small">No bookings yet.</div>';
    list.forEach(t=>{
      const div=document.createElement('div'); div.className='panel';
      div.innerHTML=`
        <div class="section-body">
          <div class="row"><b>${t.spot.title}</b><span class="small">${t.status}</span></div>
          <div class="small">${new Date(t.from).toLocaleString()} → ${new Date(t.to).toLocaleString()}</div>
          <div class="small">Plate: <b>${t.plate}</b> · Gate: <span class="kbd">${t.qr}</span></div>
          <div class="row" style="margin-top:6px">
            <button class="btn" onclick="App.extendTrip('${t.id}',30)">EXTEND +30M</button>
            <button class="btn warn" onclick="App.openGateFromTrip('${t.id}')">LIFT BARRIER</button>
            <button class="btn danger" onclick="App.cancelTrip('${t.id}')">CANCEL</button>
          </div>
        </div>`;
      tripsList.appendChild(div);
    });
  },
  extendTrip(id, minutes){
    const trips=Store.get('trips',[]), t=trips.find(x=>x.id===id); if(!t) return;
    const to=new Date(t.to); to.setMinutes(to.getMinutes()+minutes); t.to=to.toISOString();
    Store.set('trips',trips); this.renderTrips(); this.toast(`Extended by ${minutes}m`);
  },
  openGateFromTrip(id){ Router.go('find'); this.toggleGate(true); this.toast('Barrier lifted (mock)'); },
  cancelTrip(id){ const list=Store.get('trips',[]).filter(x=>x.id!==id); Store.set('trips',list); this.renderTrips(); this.toast('Booking cancelled'); },
  clearTrips(){ Store.set('trips',[]); this.renderTrips(); this.toast('All cleared'); },

  /* Host */
  addListing(){
    const title=lstTitleInput.value.trim(); if(!title){ this.toast('Enter a title'); return; }
    const rate=+lstRateInput.value||10, access=lstAccessInput.value.trim()||'QR gate';
    const tags=(lstTagsInput.value||'').split(',').map(s=>s.trim()).filter(Boolean);
    const addr=lstAddrInput.value.trim()||'—';
    const listings=Store.get('listings',[]); listings.push({id:'l'+Math.random().toString(36).slice(2,8), title, rate, access, tags, addr});
    Store.set('listings',listings); this.hide('newListingModal'); this.renderHost(); this.toast('Listing added');
  },
  renderHost(){
    const list=Store.get('listings',[]);
    hostList.innerHTML = list.length? '' : '<div class="small">No listings yet. Create one.</div>';
    list.forEach(l=>{
      const div=document.createElement('div'); div.className='panel';
      div.innerHTML=`
        <div class="section-body">
          <div class="row"><b>${l.title}</b><span class="small">AED ${l.rate}/hr</span></div>
          <div class="small">${l.addr}</div>
          <div class="small">${l.access} · ${l.tags.join(' · ')||'No tags'}</div>
          <div class="row" style="margin-top:6px">
            <button class="btn" onclick="App.copyText('Invite link: https://parkbnb.example/${l.id}')">COPY INVITE</button>
            <button class="btn danger" onclick="App.deleteListing('${l.id}')">DELETE</button>
          </div>
        </div>`;
      hostList.appendChild(div);
    });
  },
  deleteListing(id){ const list=Store.get('listings',[]).filter(x=>x.id!==id); Store.set('listings',list); this.renderHost(); this.toast('Listing removed'); },

  /* Inbox */
  sendMessage(){
    const to=msgTo.value.trim(); if(!to){ this.toast('Enter recipient'); return; }
    const msg=prompt('Message (mock):','Hello! I am interested in your spot.'); if(msg===null) return;
    const tr=document.createElement('tr'); tr.innerHTML=`<td class="small">${new Date().toLocaleString()}</td><td>${to}</td><td>${msg}</td>`;
    document.querySelector('#msgTable tbody').prepend(tr); msgTo.value=''; this.toast('Message sent (mock)');
  },

  /* Profile */
  saveProfile(){ const p={name:pName.value.trim(),phone:pPhone.value.trim(),plate:pPlate.value.trim(),ev:pEV.value}; Store.set('profile',p); this.toast('Profile saved'); },

  /* Block & Gate */
  block(id){ if(this.blockedSpots.has(id)){ this.toast('Already blocked'); return; } this.blockedSpots.add(id); this.toast('Spot blocked for 10 minutes'); setTimeout(()=>{ this.blockedSpots.delete(id); this.toast('Block expired'); }, 10*60*1000); },
  toggleGate(forceOpen=false){ const g=gate; if(forceOpen){ g.classList.add('open'); return; } g.classList.toggle('open'); },
  shareAccess(){ const code=this.genQR(); this.copyText('Share this QR: '+code); this.toast('QR copied'); },

  /* Sheet */
  openSheet(){ filterSheet.classList.add('open'); filterSheet.setAttribute('aria-hidden','false'); this.updateMobileBadges(); },
  closeSheet(){ filterSheet.classList.remove('open'); filterSheet.setAttribute('aria-hidden','true'); },

  /* UI utils */
  show(id){ document.getElementById(id).style.display='flex'; },
  hide(id){ document.getElementById(id).style.display='none'; },
  toast(msg){ const t=toast; t.textContent=msg; t.style.display='block'; clearTimeout(this._tt); this._tt=setTimeout(()=>t.style.display='none',2200); },
  copyText(txt){ navigator.clipboard?.writeText(txt).catch(()=>{}); },
  saveSearch(){ this.toast('Search saved (mock)'); }
};

window.addEventListener('DOMContentLoaded',()=>App.init());
</script>
</body>
</html>